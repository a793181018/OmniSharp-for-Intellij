# OmniSharp服务器启动和管理 - 架构设计

## 1. 架构概述

本文档详细描述了OmniSharp-for-Intellij插件中OmniSharp服务器的启动、管理和通信架构设计。该架构旨在提供可靠、高效的OmniSharp服务器集成，支持IntelliJ IDEA与OmniSharp Roslyn之间的无缝协作。

### 1.1 核心目标

- 可靠启动和管理OmniSharp服务器进程
- 提供基于Stdio协议的双向通信机制
- 实现服务器生命周期管理（启动、监控、重启、关闭）
- 提供健壮的错误处理和日志记录
- 支持配置管理和用户自定义设置
- 与IntelliJ IDEA平台深度集成

## 2. 组件架构

### 2.1 高层次架构图

```
┌───────────────────────────────────┐
│           IntelliJ IDEA           │
└───────────┬───────────┬───────────┘
            │           │
            ▼           ▼
┌───────────────────────────────────┐     ┌─────────────────┐
│  OmniSharpServerManager (服务)     │────▶│ 配置管理        │
└───────────┬───────────────────────┘     └─────────────────┘
            │
            ├───▶┌───────────────────────────────────┐
            │    │ OmniSharpProcessManager (进程管理) │
            │    └───────────┬───────────────────────┘
            │                │
            │                ▼
            │    ┌───────────────────────────────────┐
            │    │      外部OmniSharp Roslyn进程      │
            │    └───────────┬───────────────────────┘
            │                │
            ▼                │
┌───────────────────────────────────┐     ┌─────────────────┐
│  OmniSharpCommunication (通信)    │◀────▶│ JSON协议解析器  │
└───────────┬───────────────────────┘     └─────────────────┘
            │
            ▼
┌───────────────────────────────────┐
│  插件功能模块 (代码补全/导航等)     │
└───────────────────────────────────┘
```

### 2.2 核心组件说明

#### 2.2.1 OmniSharpServerManager

- **职责**：作为核心服务类，协调整个OmniSharp服务器的生命周期管理
- **特性**：
  - 单例模式，在项目级别运行
  - 管理服务器状态（启动、运行、停止、错误）
  - 提供API给插件其他部分使用
  - 处理项目打开/关闭事件

#### 2.2.2 OmniSharpProcessManager

- **职责**：负责OmniSharp服务器进程的创建、监控和终止
- **特性**：
  - 进程启动与参数配置
  - 进程状态监控
  - 自动重启机制
  - 资源清理

#### 2.2.3 OmniSharpCommunication

- **职责**：管理与OmniSharp服务器的通信
- **特性**：
  - 基于Stdio协议的双向通信
  - 请求/响应处理
  - 事件订阅与分发
  - 消息序列化与反序列化

#### 2.2.4 配置管理

- **职责**：管理OmniSharp服务器配置
- **特性**：
  - 服务器路径配置
  - 命令行参数配置
  - 用户设置持久化
  - 配置验证

#### 2.2.5 JSON协议解析器

- **职责**：处理与OmniSharp服务器的JSON消息格式
- **特性**：
  - 请求构建
  - 响应解析
  - 事件处理
  - 错误检测

## 3. 数据流与通信模式

### 3.1 请求-响应模式

```
插件功能模块 → OmniSharpServerManager → OmniSharpCommunication → JSON协议解析器 →

→ OmniSharp Roslyn进程 → JSON协议解析器 → OmniSharpCommunication → 插件功能模块
```

### 3.2 事件流

OmniSharp服务器可能会主动推送事件（如项目加载完成、诊断更新等）：

```
OmniSharp Roslyn进程 → JSON协议解析器 → OmniSharpCommunication → 事件分发器 → 订阅者
```

## 4. 生命周期管理

### 4.1 服务器启动流程

1. 插件初始化或项目打开时，`OmniSharpServerManager`开始启动流程
2. 加载并验证配置
3. 通过`OmniSharpProcessManager`启动OmniSharp Roslyn进程
4. 建立通信通道
5. 验证服务器可用性
6. 初始化事件监听
7. 通知其他组件服务器已就绪

### 4.2 服务器停止流程

1. 当项目关闭或用户手动停止时
2. `OmniSharpServerManager`通知所有组件准备关闭
3. 发送关闭请求给OmniSharp服务器
4. 通过`OmniSharpProcessManager`终止进程
5. 清理资源和通信通道
6. 通知其他组件服务器已停止

### 4.3 故障恢复

1. 检测到服务器异常终止
2. 根据配置决定是否自动重启
3. 如果重启，重复启动流程
4. 如果无法恢复，通知用户并提供手动启动选项

## 5. 错误处理策略

1. **分级错误处理**：
   - 致命错误：服务器无法启动或通信完全中断
   - 非致命错误：个别请求失败

2. **错误恢复机制**：
   - 自动重试策略
   - 服务器自动重启
   - 优雅降级

3. **用户反馈**：
   - 状态栏指示器
   - 错误通知
   - 详细日志

## 6. 扩展性考虑

1. **通信协议扩展**：
   - 支持HTTP协议作为备选通信方式
   - 插件化的消息处理器架构

2. **多版本支持**：
   - 兼容不同版本的OmniSharp Roslyn
   - 特性检测与适配

3. **测试友好**：
   - 模拟服务器实现
   - 事件驱动架构便于单元测试

## 7. 平台集成

1. **IntelliJ IDEA集成点**：
   - 项目生命周期事件
   - 状态栏组件
   - 设置界面
   - 通知系统

2. **资源管理**：
   - 内存使用监控
   - 线程池管理
   - I/O操作优化

## 8. 性能考虑

1. **通信优化**：
   - 消息批处理
   - 减少序列化开销
   - 异步通信模式

2. **资源利用**：
   - 进程优先级设置
   - 超时控制
   - 缓存机制

---

本文档提供了OmniSharp服务器启动和管理模块的整体架构设计。在实际实现过程中，可能需要根据具体情况进行调整和优化。